<!DOCTYPE HTML><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="google-site-verification" content="btmZ9kCHXQC5PXP2bsPS6_VJGmtqB19pXHG2BZDPXIo"><title>Centos7 下安装docker-ce</title><meta name="author" content="leafsummer"><meta name="description" content="Centos7 下安装docker-ce目前docker版本都更新到了docker-ce, 对各个系统的支持也越来越好. 这里以Centos7为基础, 来说明下如何安装docker-ce一. 安装依赖库1yum install -y yum-utils device-mapper-persisten"><meta property="og:title" content="Centos7 下安装docker-ce"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta property="og:site_name" content="Leaf0s Blog"><link href="/apple-touch-icon-precomposed.png" sizes="180x180" rel="apple-touch-icon-precomposed"><link rel="alternate" href="/atom.xml" title="Leaf0s Blog" type="application/atom+xml"><link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css"><link rel="stylesheet" href="/css/jquery.fancybox.css"><link rel="stylesheet" href="/css/main.css"><link rel="icon" type="image/x-icon" href="/favicon.ico"></head></html><body><a id="top"></a><div id="main"><div class="behind"><a href="/" class="back black-color"><svg class="i-close" viewBox="0 0 32 32" width="22" height="22" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="3"><path d="M2 30 L30 2 M30 30 L2 2"></path></svg></a><div class="description">&nbsp;Make things as simple as possible, But no simpler</div></div><div class="main-ctnr"><article class="standard post"><div class="title"><h1 class="page-title center">Centos7 下安装docker-ce</h1></div><div class="meta center"><time datetime="2018-06-14T12:40:45.000Z"><svg class="i-calendar" viewBox="0 0 32 32" width="16" height="16" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M2 6 L2 30 30 30 30 6 Z M2 15 L30 15 M7 3 L7 9 M13 3 L13 9 M19 3 L19 9 M25 3 L25 9"></path></svg> &nbsp; 2018-06-14 </time>&nbsp; <svg class="i-tag" viewBox="0 0 32 32" width="16" height="16" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><circle cx="24" cy="8" r="2"></circle><path d="M2 18 L18 2 30 2 30 14 14 30 Z"></path></svg> &nbsp; <a href="/categories/技术实践/">技术实践</a></div><hr><div class="picture-container"></div><p><strong>Centos7 下安装docker-ce</strong></p><p>目前docker版本都更新到了docker-ce, 对各个系统的支持也越来越好. 这里以Centos7为基础, 来说明下如何安装docker-ce</p><p>一. 安装依赖库</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2 epel-release lrzsz vim net-tools bash-completion wget bridge-utils</span><br></pre></td></tr></table></figure><p>二. 由于docker.com 被国内屏蔽了，所以按照如下的方法进行安装，可能行不通：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"><span class="comment"># 换成aliyun的(http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo)</span></span><br><span class="line"><span class="comment"># (yum-config-manager --add-repo ./docker-ce.repo)</span></span><br><span class="line">yum --enablerepo=docker-ce-stable clean metadata</span><br><span class="line">yum install docker-ce</span><br></pre></td></tr></table></figure><p>三. 如果步骤1通过docker的源无法安装, 也可以下载到本地安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install ./docker-ce-18.03.1.ce-1.el7.centos.x86_64.rpm</span><br></pre></td></tr></table></figure><p>查看是否安装成功</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum list docker-ce --showduplicates | sort -r</span><br></pre></td></tr></table></figure><p>四. 安装好docker后，通过systemd来管理</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line">systemctl start docker</span><br></pre></td></tr></table></figure><p>五. 运行hello-world镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run hello-world</span><br></pre></td></tr></table></figure><p>会自动下载镜像，输出hello world<br>查看下载的镜像 docker image ls<br>查看运行容器 docker ps</p><p>六. 安装并运行最小 ubuntu的镜像，需要挂代理</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm -t -i phusion/baseimage:v0.10.1 /sbin/my_init -- bash -l</span><br></pre></td></tr></table></figure><p>七. 后续内容</p><p>参考文档 https://yeasy.gitbooks.io/docker_practice/install/centos.html<br>docker info 命令来查看 docker的信息</p><p>推荐使用DaoCloud的镜像来加速</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL https://get.daocloud.io/daotools/set_mirror.sh | sh -s http://f1361db2.m.daocloud.io</span><br></pre></td></tr></table></figure><p>在/etc/docker/daemon.json 文件中加入</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"registry-mirrors"</span>: [<span class="string">"https://docker.mirrors.ustc.edu.cn"</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>docker search centos<br>如果报错, 修改dns为8.8.8.8</p><p>八. 扩展工具</p><p>安装监控工具<br>安装ctop来,对docker所有运行的容器进行监控</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/bcicen/ctop/releases/download/v0.7.1/ctop-0.7.1-linux-amd64 -O /usr/<span class="built_in">local</span>/bin/ctop</span><br><span class="line">chmod +x /usr/<span class="built_in">local</span>/bin/ctop</span><br></pre></td></tr></table></figure><p>安装compos工具</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://github.com/docker/compose/releases/download/1.23.1/docker-compose-Linux-x86_64 -o /usr/<span class="built_in">local</span>/bin/docker-compose</span><br><span class="line">chmod +x /usr/<span class="built_in">local</span>/bin/docker-compose</span><br><span class="line">curl -L https://raw.githubusercontent.com/docker/compose/1.22.0/contrib/completion/bash/docker-compose -o /etc/bash_completion.d/docker-compose</span><br></pre></td></tr></table></figure><p>后续可能需要docker-slim 工具 对docker进行瘦身<br>docker-gc 进行收集垃圾容器和镜像<br>watchtower 用来监控镜像</p><p>九. 问题和命令举例</p><p>register cache 配置，配置成了cache，将不能push</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Meanwhile thats possible:</span><br><span class="line">https://blog.docker.com/2015/10/registry-proxy-cache-docker-open-source/</span><br><span class="line">https://docs.docker.com/registry/recipes/mirror/</span><br><span class="line">But Pushing to such a registry is not supported:</span><br><span class="line">https://docs.docker.com/registry/configuration/<span class="comment">#proxy</span></span><br></pre></td></tr></table></figure><p>docker 的日志 目前 输入到了 /var/log/message 中了</p><p>查看网桥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brctl show</span><br></pre></td></tr></table></figure><p>在运行的容器中执行命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -i -t  mynginx /bin/bash</span><br></pre></td></tr></table></figure><p>查看镜像所占的空间</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker system df</span><br></pre></td></tr></table></figure><p>保存和加载镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker save alpine | gzip &gt; alpine-latest.tar.gz</span><br><span class="line">docker load -i alpine-latest.tar.gz</span><br><span class="line">docker save &lt;镜像名&gt; | bzip2 | pv | ssh &lt;用户名&gt;@&lt;主机名&gt; <span class="string">'cat | docker load'</span></span><br></pre></td></tr></table></figure><p>docker run 执行的动作逻辑</p><ol><li>检查本地是否存在指定的镜像，不存在就从公有仓库下载</li><li>利用镜像创建并启动一个容器</li><li>分配一个文件系统，并在只读的镜像层外面挂载一层可读写层</li><li>从宿主主机配置的网桥接口中桥接一个虚拟接口到容器中去</li><li>从地址池配置一个 ip 地址给容器</li><li>执行用户指定的应用程序</li><li>执行完毕后容器被终止</li></ol><p>导出和导入容器快照</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">export</span> 7691a814370e &gt; ubuntu.tar</span><br><span class="line">cat ubuntu.tar | docker import - <span class="built_in">test</span>/ubuntu:v1.0</span><br></pre></td></tr></table></figure><p>管理敏感数据</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openssl rand -base64 20 | docker secret create mysql_password -</span><br><span class="line">docker secret ls</span><br><span class="line">docker service create --name mysql --replicas 1 --network mysql_private --mount <span class="built_in">type</span>=volume,<span class="built_in">source</span>=mydata,destination=/var/lib/mysql --secret <span class="built_in">source</span>=mysql_root_password,target=mysql_root_password --secret <span class="built_in">source</span>=mysql_password,target=mysql_password -e MYSQL_ROOT_PASSWORD_FILE=<span class="string">"/run/secrets/mysql_root_password"</span> -e MYSQL_PASSWORD_FILE=<span class="string">"/run/secrets/mysql_password"</span> -e MYSQL_USER=<span class="string">"wordpress"</span> -e MYSQL_DATABASE=<span class="string">"wordpress"</span> mysql:latest</span><br></pre></td></tr></table></figure><p>查看docker 容器或镜像的具体信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker image ls --format <span class="string">"&#123;&#123;.ID&#125;&#125;: &#123;&#123;.Size&#125;&#125;"</span>| sort -n | uniq -c</span><br><span class="line">docker inspect -f <span class="string">"&#123;&#123;.Config.Cmd&#125;&#125;"</span> 3929</span><br></pre></td></tr></table></figure><p>查找docker的进程号:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect -f <span class="string">'&#123;&#123;.State.Pid&#125;&#125;'</span> &lt;containerid&gt;</span><br></pre></td></tr></table></figure><p>查看连接</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nsenter -t &lt;pid&gt; -n netstat | grep ESTABLISHED</span><br></pre></td></tr></table></figure><p>要解决docker宿主机和容器之间时间不一致的情况,有三种解决方法:</p><ol><li>共享主机的localtime. 创建容器的时候指定启动参数，挂载localtime文件到容器内，保证两者所采用的时区是一致的。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name &lt;name&gt; -v /etc/localtime:/etc/localtime:ro  ....</span><br></pre></td></tr></table></figure><ol start="2"><li>复制主机的localtime</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp /etc/localtime:【容器ID或者NAME】/etc/localtime</span><br></pre></td></tr></table></figure><p>在完成后，再通过date命令进行查看当前时间。<br>但是，在容器中运行的程序的时间不一定能更新过来，比如在容器运行的mysql服务，在更新时间后，通过sql查看mysql的时间<br>select now() from dual;<br>可以发现，时间并没有更改过来。<br>这时候必须要重启mysql服务或者重启docker容器，mysql才能读取到更改过后的时间。</p><ol start="3"><li>通过dockerfile来修改时间</li></ol><p>创建自定义的docker文件, 自定义了镜像的时间格式及时区</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FROM redis</span><br><span class="line">FROM tomcat</span><br><span class="line">ENV CATALINA_HOME /usr/<span class="built_in">local</span>/tomcat</span><br><span class="line"><span class="comment">#设置时区</span></span><br><span class="line">RUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span><br><span class="line">    &amp;&amp; <span class="built_in">echo</span> <span class="string">'Asia/Shanghai'</span> &gt;/etc/timezone \</span><br></pre></td></tr></table></figure><p><br><strong>本文地址</strong>： <a href="https://leaf0s.fun/2018/06/14/427468595/">https://leaf0s.fun/2018/06/14/427468595/</a></p></article><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="busuanzi center">页阅读量:&nbsp;<span id="busuanzi_value_page_pv"></span>&nbsp;・&nbsp; 站访问量:&nbsp;<span id="busuanzi_value_site_pv"></span>&nbsp;・&nbsp; 站访客数:&nbsp;<span id="busuanzi_value_site_uv"></span></div><div id="disqus_thread"></div><script>var disqus_config=function(){this.page.url="https://leaf0s.fun/2018/06/14/427468595/index.html",this.page.identifier="2018/06/14/427468595/"};!function(){var e=document,t=e.createElement("script");t.src="//www-leaf0s-fun.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)}()</script></div></div><footer class="page-footer"><div class="clearfix"></div><div class="right-foot"><div class="firstrow"><a href="#top" target="_self"><svg class="i-caret-right" viewBox="0 0 32 32" width="24" height="24" fill="none" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="3"><path d="M10 30 L26 16 10 2 Z"></path></svg> </a>© LeafSummer 2015-2020</div><div class="secondrow"><a href="https://github.com/gaoryrt/hexo-theme-pln">Theme Pln</a></div></div><div class="clearfix"></div></footer><script src="//cdn.bootcss.com/jquery/2.2.1/jquery.min.js"></script><script src="/js/search.min.js"></script><script src="/js/jquery.fancybox.min.js"></script><script src="/js/wrapImage.js"></script><script type="text/javascript">var disqus_shortname="www-leaf0s-fun";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("body")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}(),$(".dropdown").click(function(e){var n=$(this);e.stopPropagation(),$(n).children(".dropdown-content")[$(n).children(".dropdown-content").hasClass("open")?"removeClass":"addClass"]("open")}),$(document).click(function(){$(".dropdown-content").removeClass("open")});var path="/search.xml";searchFunc(path,"local-search-input","local-search-result")</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-144177217-1"></script><script>var host=window.location.hostname;if("localhost"!==host||"127.0.0.1"!==host){function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-144177217-1")}</script></body>